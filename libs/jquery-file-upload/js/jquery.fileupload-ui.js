/*
 * jQuery File Upload User Interface Plugin 6.9.1
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2010, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */

/*jslint nomen: true, unparam: true, regexp: true */
/*global define, window, document, URL, webkitURL, FileReader */
!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","tmpl","load-image","./jquery.fileupload-fp"],e):e(window.jQuery,window.tmpl,window.loadImage)}((function(e,t,i){"use strict";var n=(e.blueimpFP||e.blueimp).fileupload;e.widget("blueimpUI.fileupload",n,{options:{autoUpload:!1,maxNumberOfFiles:void 0,maxFileSize:void 0,minFileSize:void 0,acceptFileTypes:/.+$/i,previewSourceFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceMaxFileSize:5e6,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:!0,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:void 0,prependFiles:!1,dataType:"json",add:function(t,i){var n=e(this).data("fileupload"),o=n.options,a=i.files;e(this).fileupload("process",i).done((function(){n._adjustMaxNumberOfFiles(-a.length),i.isAdjusted=!0,i.files.valid=i.isValidated=n._validate(a),i.context=n._renderUpload(a).data("data",i),o.filesContainer[o.prependFiles?"prepend":"append"](i.context),n._renderPreviews(a,i.context),n._forceReflow(i.context),n._transition(i.context).done((function(){!1!==n._trigger("added",t,i)&&(o.autoUpload||i.autoUpload)&&!1!==i.autoUpload&&i.isValidated&&i.submit()}))}))},send:function(t,i){var n=e(this).data("fileupload");return!(!i.isValidated&&(i.isAdjusted||n._adjustMaxNumberOfFiles(-i.files.length),!n._validate(i.files)))&&(i.context&&i.dataType&&"iframe"===i.dataType.substr(0,6)&&i.context.find(".progress").addClass(!e.support.transition&&"progress-animated").attr("aria-valuenow",100).find(".bar").css("width","100%"),n._trigger("sent",t,i))},done:function(t,i){var n,o=e(this).data("fileupload");i.context?i.context.each((function(a){var r=e.isArray(i.result)&&i.result[a]||{error:"emptyResult"};r.error&&o._adjustMaxNumberOfFiles(1),o._transition(e(this)).done((function(){var a=e(this);n=o._renderDownload([r]).css("height",a.height()).replaceAll(a),o._forceReflow(n),o._transition(n).done((function(){i.context=e(this),o._trigger("completed",t,i)}))}))})):(n=o._renderDownload(i.result).appendTo(o.options.filesContainer),o._forceReflow(n),o._transition(n).done((function(){i.context=e(this),o._trigger("completed",t,i)})))},fail:function(t,i){var n,o=e(this).data("fileupload");o._adjustMaxNumberOfFiles(i.files.length),i.context?i.context.each((function(a){if("abort"!==i.errorThrown){var r=i.files[a];r.error=r.error||i.errorThrown||!0,o._transition(e(this)).done((function(){var a=e(this);n=o._renderDownload([r]).replaceAll(a),o._forceReflow(n),o._transition(n).done((function(){i.context=e(this),o._trigger("failed",t,i)}))}))}else o._transition(e(this)).done((function(){e(this).remove(),o._trigger("failed",t,i)}))})):"abort"!==i.errorThrown?(o._adjustMaxNumberOfFiles(-i.files.length),i.context=o._renderUpload(i.files).appendTo(o.options.filesContainer).data("data",i),o._forceReflow(i.context),o._transition(i.context).done((function(){i.context=e(this),o._trigger("failed",t,i)}))):o._trigger("failed",t,i)},progress:function(e,t){if(t.context){var i=parseInt(t.loaded/t.total*100,10);t.context.find(".progress").attr("aria-valuenow",i).find(".bar").css("width",i+"%")}},progressall:function(t,i){var n=e(this),o=parseInt(i.loaded/i.total*100,10),a=n.find(".fileupload-progress"),r=a.find(".progress-extended");r.length&&r.html(n.data("fileupload")._renderExtendedProgress(i)),a.find(".progress").attr("aria-valuenow",o).find(".bar").css("width",o+"%")},start:function(t){var i=e(this).data("fileupload");i._transition(e(this).find(".fileupload-progress")).done((function(){i._trigger("started",t)}))},stop:function(t){var i=e(this).data("fileupload");i._transition(e(this).find(".fileupload-progress")).done((function(){e(this).find(".progress").attr("aria-valuenow","0").find(".bar").css("width","0%"),e(this).find(".progress-extended").html("&nbsp;"),i._trigger("stopped",t)}))},destroy:function(t,i){var n=e(this).data("fileupload");i.url&&(e.ajax(i),n._adjustMaxNumberOfFiles(1)),n._transition(i.context).done((function(){e(this).remove(),n._trigger("destroyed",t,i)}))}},_enableDragToDesktop:function(){var t=e(this),i=t.prop("href"),n=t.prop("download"),o="application/octet-stream";t.bind("dragstart",(function(e){try{e.originalEvent.dataTransfer.setData("DownloadURL",[o,n,i].join(":"))}catch(e){}}))},_adjustMaxNumberOfFiles:function(e){"number"==typeof this.options.maxNumberOfFiles&&(this.options.maxNumberOfFiles+=e,this.options.maxNumberOfFiles<1?this._disableFileInputButton():this._enableFileInputButton())},_formatFileSize:function(e){return"number"!=typeof e?"":e>=1e9?(e/1e9).toFixed(2)+" GB":e>=1e6?(e/1e6).toFixed(2)+" MB":(e/1e3).toFixed(2)+" KB"},_formatBitrate:function(e){return"number"!=typeof e?"":e>=1e9?(e/1e9).toFixed(2)+" Gbit/s":e>=1e6?(e/1e6).toFixed(2)+" Mbit/s":e>=1e3?(e/1e3).toFixed(2)+" kbit/s":e+" bit/s"},_formatTime:function(e){var t=new Date(1e3*e),i=parseInt(e/86400,10);return(i=i?i+"d ":"")+("0"+t.getUTCHours()).slice(-2)+":"+("0"+t.getUTCMinutes()).slice(-2)+":"+("0"+t.getUTCSeconds()).slice(-2)},_formatPercentage:function(e){return(100*e).toFixed(2)+" %"},_renderExtendedProgress:function(e){return this._formatBitrate(e.bitrate)+" | "+this._formatTime(8*(e.total-e.loaded)/e.bitrate)+" | "+this._formatPercentage(e.loaded/e.total)+" | "+this._formatFileSize(e.loaded)+" / "+this._formatFileSize(e.total)},_hasError:function(e){return e.error?e.error:this.options.maxNumberOfFiles<0?"maxNumberOfFiles":this.options.acceptFileTypes.test(e.type)||this.options.acceptFileTypes.test(e.name)?this.options.maxFileSize&&e.size>this.options.maxFileSize?"maxFileSize":"number"==typeof e.size&&e.size<this.options.minFileSize?"minFileSize":null:"acceptFileTypes"},_validate:function(t){var i=this,n=!!t.length;return e.each(t,(function(e,t){t.error=i._hasError(t),t.error&&(n=!1)})),n},_renderTemplate:function(t,i){if(!t)return e();var n=t({files:i,formatFileSize:this._formatFileSize,options:this.options});return n instanceof e?n:e(this.options.templatesContainer).html(n).children()},_renderPreview:function(t,n){var o=this,a=this.options,r=e.Deferred();return(i&&i(t,(function(t){n.append(t),o._forceReflow(n),o._transition(n).done((function(){r.resolveWith(n)})),e.contains(document.body,n[0])||r.resolveWith(n)}),{maxWidth:a.previewMaxWidth,maxHeight:a.previewMaxHeight,canvas:a.previewAsCanvas})||r.resolveWith(n))&&r},_renderPreviews:function(t,i){var n=this,o=this.options;return i.find(".preview span").each((function(i,a){var r=t[i];o.previewSourceFileTypes.test(r.type)&&("number"!==e.type(o.previewSourceMaxFileSize)||r.size<o.previewSourceMaxFileSize)&&(n._processingQueue=n._processingQueue.pipe((function(){var t=e.Deferred();return n._renderPreview(r,e(a)).done((function(){t.resolveWith(n)})),t.promise()})))})),this._processingQueue},_renderUpload:function(e){return this._renderTemplate(this.options.uploadTemplate,e)},_renderDownload:function(e){return this._renderTemplate(this.options.downloadTemplate,e).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(t){t.preventDefault();var i=e(this),n=i.closest(".template-upload").data("data");n&&n.submit&&!n.jqXHR&&n.submit()&&i.prop("disabled",!0)},_cancelHandler:function(t){t.preventDefault();var i=e(this).closest(".template-upload").data("data")||{};i.jqXHR?i.jqXHR.abort():(i.errorThrown="abort",t.data.fileupload._trigger("fail",t,i))},_deleteHandler:function(t){t.preventDefault();var i=e(this);t.data.fileupload._trigger("destroy",t,{context:i.closest(".template-download"),url:i.attr("data-url"),type:i.attr("data-type")||"DELETE",dataType:t.data.fileupload.options.dataType})},_forceReflow:function(t){return e.support.transition&&t.length&&t[0].offsetWidth},_transition:function(t){var i=e.Deferred();return e.support.transition&&t.hasClass("fade")?t.bind(e.support.transition.end,(function(n){n.target===t[0]&&(t.unbind(e.support.transition.end),i.resolveWith(t))})).toggleClass("in"):(t.toggleClass("in"),i.resolveWith(t)),i},_initButtonBarEventHandlers:function(){var t=this.element.find(".fileupload-buttonbar"),i=this.options.filesContainer,n=this.options.namespace;t.find(".start").bind("click."+n,(function(e){e.preventDefault(),i.find(".start button").click()})),t.find(".cancel").bind("click."+n,(function(e){e.preventDefault(),i.find(".cancel button").click()})),t.find(".delete").bind("click."+n,(function(e){e.preventDefault(),i.find(".delete input:checked").siblings("button").click(),t.find(".toggle").prop("checked",!1)})),t.find(".toggle").bind("change."+n,(function(t){i.find(".delete input").prop("checked",e(this).is(":checked"))}))},_destroyButtonBarEventHandlers:function(){this.element.find(".fileupload-buttonbar button").unbind("click."+this.options.namespace),this.element.find(".fileupload-buttonbar .toggle").unbind("change."+this.options.namespace)},_initEventHandlers:function(){n.prototype._initEventHandlers.call(this);var e={fileupload:this};this.options.filesContainer.delegate(".start button","click."+this.options.namespace,e,this._startHandler).delegate(".cancel button","click."+this.options.namespace,e,this._cancelHandler).delegate(".delete button","click."+this.options.namespace,e,this._deleteHandler),this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){var e=this.options;this._destroyButtonBarEventHandlers(),e.filesContainer.undelegate(".start button","click."+e.namespace).undelegate(".cancel button","click."+e.namespace).undelegate(".delete button","click."+e.namespace),n.prototype._destroyEventHandlers.call(this)},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!1).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!0).parent().addClass("disabled")},_initTemplates:function(){var e=this.options;e.templatesContainer=document.createElement(e.filesContainer.prop("nodeName")),t&&(e.uploadTemplateId&&(e.uploadTemplate=t(e.uploadTemplateId)),e.downloadTemplateId&&(e.downloadTemplate=t(e.downloadTemplateId)))},_initFilesContainer:function(){var t=this.options;void 0===t.filesContainer?t.filesContainer=this.element.find(".files"):t.filesContainer instanceof e||(t.filesContainer=e(t.filesContainer))},_initSpecialOptions:function(){n.prototype._initSpecialOptions.call(this),this._initFilesContainer(),this._initTemplates()},_create:function(){n.prototype._create.call(this),this._refreshOptionsList.push("filesContainer","uploadTemplateId","downloadTemplateId"),e.blueimpFP||(this._processingQueue=e.Deferred().resolveWith(this).promise(),this.process=function(){return this._processingQueue})},enable:function(){n.prototype.enable.call(this),this.element.find("input, button").prop("disabled",!1),this._enableFileInputButton()},disable:function(){this.element.find("input, button").prop("disabled",!0),this._disableFileInputButton(),n.prototype.disable.call(this)}})}));