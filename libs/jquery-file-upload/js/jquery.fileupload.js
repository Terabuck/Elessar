/*
 * jQuery File Upload Plugin 5.12
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2010, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */

/*jslint nomen: true, unparam: true, regexp: true */
/*global define, window, document, Blob, FormData, location */
!function(t){"use strict";"function"==typeof define&&define.amd?define(["jquery","jquery.ui.widget"],t):t(window.jQuery)}((function(t){"use strict";t.support.xhrFileUpload=!(!window.XMLHttpRequestUpload||!window.FileReader),t.support.xhrFormDataFileUpload=!!window.FormData,t.widget("blueimp.fileupload",{options:{namespace:void 0,dropZone:t(document),fileInput:void 0,replaceFileInput:!0,paramName:void 0,singleFileUploads:!0,limitMultiFileUploads:void 0,sequentialUploads:!1,limitConcurrentUploads:void 0,forceIframeTransport:!1,redirect:void 0,redirectParamName:void 0,postMessage:void 0,multipart:!0,maxChunkSize:void 0,uploadedBytes:void 0,recalculateProgress:!0,progressInterval:100,bitrateInterval:500,formData:function(t){return t.serializeArray()},add:function(t,e){e.submit()},processData:!1,contentType:!1,cache:!1},_refreshOptionsList:["namespace","dropZone","fileInput","multipart","forceIframeTransport"],_BitrateTimer:function(){this.timestamp=+new Date,this.loaded=0,this.bitrate=0,this.getBitrate=function(t,e,i){var n=t-this.timestamp;return(!this.bitrate||!i||n>i)&&(this.bitrate=(e-this.loaded)*(1e3/n)*8,this.loaded=e,this.timestamp=t),this.bitrate}},_isXHRUpload:function(e){return!e.forceIframeTransport&&(!e.multipart&&t.support.xhrFileUpload||t.support.xhrFormDataFileUpload)},_getFormData:function(e){var i;return"function"==typeof e.formData?e.formData(e.form):t.isArray(e.formData)?e.formData:e.formData?(i=[],t.each(e.formData,(function(t,e){i.push({name:t,value:e})})),i):[]},_getTotal:function(e){var i=0;return t.each(e,(function(t,e){i+=e.size||1})),i},_onProgress:function(t,e){if(t.lengthComputable){var i,n,a=+new Date;if(e._time&&e.progressInterval&&a-e._time<e.progressInterval&&t.loaded!==t.total)return;e._time=a,i=e.total||this._getTotal(e.files),n=parseInt(t.loaded/t.total*(e.chunkSize||i),10)+(e.uploadedBytes||0),this._loaded+=n-(e.loaded||e.uploadedBytes||0),e.lengthComputable=!0,e.loaded=n,e.total=i,e.bitrate=e._bitrateTimer.getBitrate(a,n,e.bitrateInterval),this._trigger("progress",t,e),this._trigger("progressall",t,{lengthComputable:!0,loaded:this._loaded,total:this._total,bitrate:this._bitrateTimer.getBitrate(a,this._loaded,e.bitrateInterval)})}},_initProgressListener:function(e){var i=this,n=e.xhr?e.xhr():t.ajaxSettings.xhr();n.upload&&(t(n.upload).bind("progress",(function(t){var n=t.originalEvent;t.lengthComputable=n.lengthComputable,t.loaded=n.loaded,t.total=n.total,i._onProgress(t,e)})),e.xhr=function(){return n})},_initXHRData:function(e){var i,n=e.files[0],a=e.multipart||!t.support.xhrFileUpload,o=e.paramName[0];a&&!e.blob||(e.headers=t.extend(e.headers,{"X-File-Name":n.name,"X-File-Type":n.type,"X-File-Size":n.size}),e.blob?a||(e.contentType="application/octet-stream",e.data=e.blob):(e.contentType=n.type,e.data=n)),a&&t.support.xhrFormDataFileUpload&&(e.postMessage?(i=this._getFormData(e),e.blob?i.push({name:o,value:e.blob}):t.each(e.files,(function(t,n){i.push({name:e.paramName[t]||o,value:n})}))):(e.formData instanceof FormData?i=e.formData:(i=new FormData,t.each(this._getFormData(e),(function(t,e){i.append(e.name,e.value)}))),e.blob?i.append(o,e.blob,n.name):t.each(e.files,(function(t,n){n instanceof Blob&&i.append(e.paramName[t]||o,n,n.name)}))),e.data=i),e.blob=null},_initIframeSettings:function(e){e.dataType="iframe "+(e.dataType||""),e.formData=this._getFormData(e),e.redirect&&t("<a></a>").prop("href",e.url).prop("host")!==location.host&&e.formData.push({name:e.redirectParamName||"redirect",value:e.redirect})},_initDataSettings:function(t){this._isXHRUpload(t)?(this._chunkedUpload(t,!0)||(t.data||this._initXHRData(t),this._initProgressListener(t)),t.postMessage&&(t.dataType="postmessage "+(t.dataType||""))):this._initIframeSettings(t,"iframe")},_getParamName:function(e){var i=t(e.fileInput),n=e.paramName;return n?t.isArray(n)||(n=[n]):(n=[],i.each((function(){for(var e=t(this),i=e.prop("name")||"files[]",a=(e.prop("files")||[1]).length;a;)n.push(i),a-=1})),n.length||(n=[i.prop("name")||"files[]"])),n},_initFormSettings:function(e){e.form&&e.form.length||(e.form=t(e.fileInput.prop("form"))),e.paramName=this._getParamName(e),e.url||(e.url=e.form.prop("action")||location.href),e.type=(e.type||e.form.prop("method")||"").toUpperCase(),"POST"!==e.type&&"PUT"!==e.type&&(e.type="POST")},_getAJAXSettings:function(e){var i=t.extend({},this.options,e);return this._initFormSettings(i),this._initDataSettings(i),i},_enhancePromise:function(t){return t.success=t.done,t.error=t.fail,t.complete=t.always,t},_getXHRPromise:function(e,i,n){var a=t.Deferred(),o=a.promise();return i=i||this.options.context||o,!0===e?a.resolveWith(i,n):!1===e&&a.rejectWith(i,n),o.abort=a.promise,this._enhancePromise(o)},_chunkedUpload:function(e,i){var n,a,o,r,s=this,l=e.files[0],p=l.size,d=e.uploadedBytes=e.uploadedBytes||0,u=e.maxChunkSize||p,h=l.webkitSlice||l.mozSlice||l.slice;return!(!(this._isXHRUpload(e)&&h&&(d||u<p))||e.data)&&(!!i||(d>=p?(l.error="uploadedBytes",this._getXHRPromise(!1,e.context,[null,"error",l.error])):(a=Math.ceil((p-d)/u),(r=(n=function(i){return i?n(i-=1).pipe((function(){var n=t.extend({},e);return n.blob=h.call(l,d+i*u,d+(i+1)*u),n.chunkSize=n.blob.size,s._initXHRData(n),s._initProgressListener(n),o=(t.ajax(n)||s._getXHRPromise(!1,n.context)).done((function(){n.loaded||s._onProgress(t.Event("progress",{lengthComputable:!0,loaded:n.chunkSize,total:n.chunkSize}),n),e.uploadedBytes=n.uploadedBytes+=n.chunkSize}))})):s._getXHRPromise(!0,e.context)})(a)).abort=function(){return o.abort()},this._enhancePromise(r))))},_beforeSend:function(t,e){0===this._active&&(this._trigger("start"),this._bitrateTimer=new this._BitrateTimer),this._active+=1,this._loaded+=e.uploadedBytes||0,this._total+=this._getTotal(e.files)},_onDone:function(e,i,n,a){this._isXHRUpload(a)||this._onProgress(t.Event("progress",{lengthComputable:!0,loaded:1,total:1}),a),a.result=e,a.textStatus=i,a.jqXHR=n,this._trigger("done",null,a)},_onFail:function(t,e,i,n){n.jqXHR=t,n.textStatus=e,n.errorThrown=i,this._trigger("fail",null,n),n.recalculateProgress&&(this._loaded-=n.loaded||n.uploadedBytes||0,this._total-=n.total||this._getTotal(n.files))},_onAlways:function(t,e,i,n){this._active-=1,n.textStatus=e,i&&i.always?(n.jqXHR=i,n.result=t):(n.jqXHR=t,n.errorThrown=i),this._trigger("always",null,n),0===this._active&&(this._trigger("stop"),this._loaded=this._total=0,this._bitrateTimer=null)},_onSend:function(e,i){var n,a,o,r=this,s=r._getAJAXSettings(i),l=function(i,a){return r._sending+=1,s._bitrateTimer=new r._BitrateTimer,n=n||(!1!==i&&!1!==r._trigger("send",e,s)&&(r._chunkedUpload(s)||t.ajax(s))||r._getXHRPromise(!1,s.context,a)).done((function(t,e,i){r._onDone(t,e,i,s)})).fail((function(t,e,i){r._onFail(t,e,i,s)})).always((function(t,e,i){if(r._sending-=1,r._onAlways(t,e,i,s),s.limitConcurrentUploads&&s.limitConcurrentUploads>r._sending)for(var n=r._slots.shift();n;){if(!n.isRejected()){n.resolve();break}n=r._slots.shift()}}))};return this._beforeSend(e,s),this.options.sequentialUploads||this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending?(this.options.limitConcurrentUploads>1?(a=t.Deferred(),this._slots.push(a),o=a.pipe(l)):o=this._sequence=this._sequence.pipe(l,l),o.abort=function(){var t=[void 0,"abort","abort"];return n?n.abort():(a&&a.rejectWith(t),l(!1,t))},this._enhancePromise(o)):l()},_onAdd:function(e,i){var n,a,o,r,s=this,l=!0,p=t.extend({},this.options,i),d=p.limitMultiFileUploads,u=this._getParamName(p);if((p.singleFileUploads||d)&&this._isXHRUpload(p))if(!p.singleFileUploads&&d)for(o=[],n=[],r=0;r<i.files.length;r+=d)o.push(i.files.slice(r,r+d)),(a=u.slice(r,r+d)).length||(a=u),n.push(a);else n=u;else o=[i.files],n=[u];return i.originalFiles=i.files,t.each(o||i.files,(function(a,r){var p=t.extend({},i);return p.files=o?r:[r],p.paramName=n[a],p.submit=function(){return p.jqXHR=this.jqXHR=!1!==s._trigger("submit",e,this)&&s._onSend(e,this),this.jqXHR},l=s._trigger("add",e,p)})),l},_normalizeFile:function(t,e){void 0===e.name&&void 0===e.size&&(e.name=e.fileName,e.size=e.fileSize)},_replaceFileInput:function(e){var i=e.clone(!0);t("<form></form>").append(i)[0].reset(),e.after(i).detach(),t.cleanData(e.unbind("remove")),this.options.fileInput=this.options.fileInput.map((function(t,n){return n===e[0]?i[0]:n})),e[0]===this.element[0]&&(this.element=i)},_getFileInputFiles:function(e){e=t(e);var i,n=t.each(t.makeArray(e.prop("files")),this._normalizeFile);if(!n.length){if(!(i=e.prop("value")))return[];n=[{name:i.replace(/^.*\\/,"")}]}return n},_onChange:function(e){var i=e.data.fileupload,n={fileInput:t(e.target),form:t(e.target.form)};if(n.files=i._getFileInputFiles(n.fileInput),i.options.replaceFileInput&&i._replaceFileInput(n.fileInput),!1===i._trigger("change",e,n)||!1===i._onAdd(e,n))return!1},_onPaste:function(e){var i=e.data.fileupload,n=e.originalEvent.clipboardData,a=n&&n.items||[],o={files:[]};if(t.each(a,(function(t,e){var i=e.getAsFile&&e.getAsFile();i&&o.files.push(i)})),!1===i._trigger("paste",e,o)||!1===i._onAdd(e,o))return!1},_onDrop:function(e){var i=e.data.fileupload,n=e.dataTransfer=e.originalEvent.dataTransfer,a={files:t.each(t.makeArray(n&&n.files),i._normalizeFile)};if(!1===i._trigger("drop",e,a)||!1===i._onAdd(e,a))return!1;e.preventDefault()},_onDragOver:function(t){var e=t.data.fileupload,i=t.dataTransfer=t.originalEvent.dataTransfer;if(!1===e._trigger("dragover",t))return!1;i&&(i.dropEffect="copy"),t.preventDefault()},_initEventHandlers:function(){var t=this.options.namespace;this._isXHRUpload(this.options)&&this.options.dropZone.bind("dragover."+t,{fileupload:this},this._onDragOver).bind("drop."+t,{fileupload:this},this._onDrop).bind("paste."+t,{fileupload:this},this._onPaste),this.options.fileInput.bind("change."+t,{fileupload:this},this._onChange)},_destroyEventHandlers:function(){var t=this.options.namespace;this.options.dropZone.unbind("dragover."+t,this._onDragOver).unbind("drop."+t,this._onDrop).unbind("paste."+t,this._onPaste),this.options.fileInput.unbind("change."+t,this._onChange)},_setOption:function(e,i){var n=-1!==t.inArray(e,this._refreshOptionsList);n&&this._destroyEventHandlers(),t.Widget.prototype._setOption.call(this,e,i),n&&(this._initSpecialOptions(),this._initEventHandlers())},_initSpecialOptions:function(){var e=this.options;void 0===e.fileInput?e.fileInput=this.element.is("input:file")?this.element:this.element.find("input:file"):e.fileInput instanceof t||(e.fileInput=t(e.fileInput)),e.dropZone instanceof t||(e.dropZone=t(e.dropZone))},_create:function(){var e=this.options;t.extend(e,t(this.element[0].cloneNode(!1)).data()),e.namespace=e.namespace||this.widgetName,this._initSpecialOptions(),this._slots=[],this._sequence=this._getXHRPromise(!0),this._sending=this._active=this._loaded=this._total=0,this._initEventHandlers()},destroy:function(){this._destroyEventHandlers(),t.Widget.prototype.destroy.call(this)},enable:function(){t.Widget.prototype.enable.call(this),this._initEventHandlers()},disable:function(){this._destroyEventHandlers(),t.Widget.prototype.disable.call(this)},add:function(e){e&&!this.options.disabled&&(e.fileInput&&!e.files?e.files=this._getFileInputFiles(e.fileInput):e.files=t.each(t.makeArray(e.files),this._normalizeFile),this._onAdd(null,e))},send:function(e){return e&&!this.options.disabled&&(e.fileInput&&!e.files?e.files=this._getFileInputFiles(e.fileInput):e.files=t.each(t.makeArray(e.files),this._normalizeFile),e.files.length)?this._onSend(null,e):this._getXHRPromise(!1,e&&e.context)}})}));